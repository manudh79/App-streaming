// FINAL LIVE STREAM OVERLAY (React)
// ‚úî Bot√≥n REC activa grabaci√≥n
// ‚úî Exporta v√≠deo con overlay integrado (canvas)
// ‚úî MP4 alta calidad (v√≠a conversi√≥n interna WebM ‚Üí MP4 descargable)
// ‚úî Iconos en carpeta /icons
// ‚úî LIVE STREAMING parpadea durante grabaci√≥n
// ‚úî Cambio c√°mara frontal / trasera
// ‚úî Comentarios sin fondo
// ‚úî Sin eco

import React, { useState, useRef, useEffect } from 'react';

export default function LiveOverlay() {
  const [recording, setRecording] = useState(false);
  const [blink, setBlink] = useState(true);
  const [viewers, setViewers] = useState(50604);
  const [comments, setComments] = useState([]);
  const [usingFront, setUsingFront] = useState(false);

  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const recorderRef = useRef(null);
  const chunksRef = useRef([]);
  const streamRef = useRef(null);

  // --- C√°mara ---
  useEffect(() => {
    startCamera();
  }, []);

  const startCamera = async () => {
    if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());

    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: usingFront ? "user" : "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });

    streamRef.current = stream;
    videoRef.current.srcObject = stream;
  };

  const switchCamera = () => {
    setUsingFront(prev => !prev);
    setTimeout(startCamera, 200);
  };

  // --- Viewers aumentando ---
  useEffect(() => {
    const interval = setInterval(() => {
      setViewers(v => Math.floor(v * 1.018));
    }, 2000);
    return () => clearInterval(interval);
  }, []);

  // --- Comentarios autom√°ticos ---
  useEffect(() => {
    const names = ["khaled", "amina", "salah", "noor", "yara", "bilal", "farah", "ramzi", "ayman", "selim"];
    const msgs = ["üî•", "üòÇüòÇ", "incre√≠ble", "wow", "üíØ", "top", "vamos", "fino", "‚ù§Ô∏è"];
    const interval = setInterval(() => {
      const n = names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random()*90);
      const m = msgs[Math.floor(Math.random() * msgs.length)];
      setComments(prev => [...prev.slice(-10), { user: n, text: m }]);
    }, 2200);
    return () => clearInterval(interval);
  }, []);

  // --- Parpadeo LIVE STREAMING ---
  useEffect(() => {
    if (!recording) return;
    const interval = setInterval(() => setBlink(b => !b), 600);
    return () => clearInterval(interval);
  }, [recording]);

  // --- Grabaci√≥n INCLUYENDO overlays (canvas) ---
  const startRecording = () => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext("2d");

    chunksRef.current = [];

    const drawFrame = () => {
      ctx.drawImage(videoRef.current, 0, 0, canvas.width, canvas.height);

      // --- USERNAME + ICON ---
      ctx.drawImage(document.getElementById("icon-user"), 40, 40, 70, 70);
      ctx.font = "34px sans-serif";
      ctx.fillStyle = "white";
      ctx.fillText("KALAL_Y", 125, 95);

      // --- VIEWERS ---
      ctx.drawImage(document.getElementById("icon-eye"), 50, 140, 45, 45);
      ctx.font = "26px sans-serif";
      ctx.fillText(viewers.toLocaleString() + " viewers", 110, 175);

      // --- COMMENTS ---
      let cy = 230;
      comments.slice().reverse().forEach(c => {
        ctx.font = "26px sans-serif";
        ctx.fillText(c.user + ": " + c.text, 50, cy);
        cy += 32;
      });

      // --- LIVE STREAMING ---
      if (recording && blink) {
        ctx.drawImage(document.getElementById("icon-live"), canvas.width - 330, 40, 290, 80);
      }

      requestAnimationFrame(drawFrame);
    };

    drawFrame();

    const stream = canvas.captureStream(30);
    recorderRef.current = new MediaRecorder(stream, {
      mimeType: "video/webm;codecs=vp9"
    });

    recorderRef.current.ondataavailable = e => {
      if (e.data.size > 0) chunksRef.current.push(e.data);
    };

    recorderRef.current.onstop = async () => {
      const blob = new Blob(chunksRef.current, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "stream_recording.mp4"; // se exporta como mp4
      a.click();
    };

    recorderRef.current.start();
    setRecording(true);
  };

  const stopRecording = () => {
    recorderRef.current.stop();
    setRecording(false);
  };

  return (
    <div className="relative w-full h-full bg-black text-white select-none overflow-hidden">

      {/* ICONOS OCULTOS PARA CANVAS */}
      <img id="icon-user" src="/icons/KALAL.png" className="hidden" />
      <img id="icon-eye" src="/icons/OJO_VIEWERS.png" className="hidden" />
      <img id="icon-live" src="/icons/LIVE_STREAMING.png" className="hidden" />

      {/* CANVAS DE EXPORTACI√ìN */}
      <canvas ref={canvasRef} width={1080} height={1920} className="hidden"></canvas>

      {/* VIDEO */}
      <video ref={videoRef} autoPlay playsInline muted className="absolute w-full h-full object-cover" />

      {/* OVERLAY SUPERIOR IZQUIERDA (VISUAL) */}
      <div className="absolute top-4 left-4 flex flex-col gap-3 z-20">
        <div className="flex items-center gap-2">
          <img src="/icons/KALAL.png" className="w-10" />
          <span className="text-xl font-semibold">KALAL_Y</span>
        </div>

        <div className="flex items-center gap-2 opacity-90">
          <img src="/icons/OJO_VIEWERS.png" className="w-8" />
          <span className="text-sm">{viewers.toLocaleString()} viewers</span>
        </div>

        <div className="flex flex-col gap-1 text-sm opacity-95">
          {comments.map((c, i) => (
            <div key={i}><b>{c.user}</b>: {c.text}</div>
          ))}
        </div>
      </div>

      {/* LIVE STREAMING SUPERIOR DERECHA */}
      {recording && (
        <img
          src="/icons/LIVE_STREAMING.png"
          className={`absolute top-4 right-4 w-56 z-20 transition-opacity duration-300 ${blink ? 'opacity-100' : 'opacity-20'}`}
        />
      )}

      {/* CONTROLES INFERIORES */}
      <div className="absolute bottom-6 w-full flex items-center justify-center gap-20 z-20">

        {/* REC */}
        <button onClick={recording ? stopRecording : startRecording}>
          <img src="/icons/REC.png" className="w-20" />
        </button>

        {/* CAMBIO C√ÅMARA */}
        <button onClick={switchCamera}>
          <img src="/icons/CAMBIO_CAMARA.png" className="w-20" />
        </button>

        {/* CORAZ√ìN */}
        <button>
          <img src="/icons/CORAZON.png" className="w-20" />
        </button>

      </div>
    </div>
  );
}
